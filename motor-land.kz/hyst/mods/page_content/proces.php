<?php
// Защита от повторного запуска сессии
if (session_status() === PHP_SESSION_NONE) {
	session_start();
}
include_once($_SERVER['DOCUMENT_ROOT'].'/hyst/config.php');
include_once($_SERVER['DOCUMENT_ROOT'].'/hyst/core/constants.php');
include_once($_SERVER['DOCUMENT_ROOT'].'/hyst/core/functions.php');
include_once($_SERVER['DOCUMENT_ROOT'].'/hyst/core/setups.php');

// Создание таблицы для контента страниц
$check = $_DB_CONECT->query("SELECT table_name FROM information_schema.tables WHERE table_schema = '".DB_BASE."' AND table_name = 'page_content'");
if ($check->num_rows == 0) {
	$_DB_CONECT->query("CREATE TABLE page_content (
		id INT(9) NOT NULL AUTO_INCREMENT PRIMARY KEY,
		page_key VARCHAR(100) NOT NULL UNIQUE,
		page_name VARCHAR(255) NOT NULL,
		h1_text VARCHAR(500) NOT NULL,
		content LONGTEXT NOT NULL,
		meta_title VARCHAR(255) NOT NULL,
		meta_description TEXT NOT NULL,
		meta_keywords TEXT NOT NULL,
		date_modified DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		INDEX idx_page_key (page_key)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci");
	
	// Инициализация страниц отключена - страницы редактируются через customtexts
	// Если нужно снова активировать, раскомментируйте код ниже
	$default_pages = [];
	/*
	$default_pages = [
		['service_page', 'Автосервис', 'Замена Контрактного Двигателя в Алматы', '<div class="guarantee-hero">
<h2>Профессиональный автосервис по замене контрактных двигателей и КПП</h2>
<p>Компания Motor Land предлагает полный спектр услуг по замене и обслуживанию контрактных двигателей и коробок передач. Наш автосервис оснащен современным оборудованием, а наши мастера имеют многолетний опыт работы с автомобилями всех марок и моделей.</p>
</div>

<div class="guarantee-section">
<h3>Замена контрактного двигателя</h3>
<p>Замена двигателя — это сложная процедура, требующая профессионального подхода и внимания к деталям. Наши специалисты выполняют полный комплекс работ:</p>
<ul>
<li>Демонтаж старого двигателя с соблюдением всех технологических требований</li>
<li>Тщательная диагностика систем автомобиля перед установкой нового двигателя</li>
<li>Установка контрактного двигателя с подключением всех систем и агрегатов</li>
<li>Замена расходных материалов: масло, фильтры, ремни, сальники</li>
<li>Проверка работы всех систем и настройка электронного блока управления</li>
<li>Обкатка и финальная диагностика после установки</li>
</ul>
<p>Время выполнения работ по замене двигателя составляет от <strong>1 до 3 рабочих дней</strong> в зависимости от сложности и марки автомобиля.</p>
</div>

<div class="guarantee-section">
<h3>Замена коробки передач (АКПП и МКПП)</h3>
<p>Замена автоматической или механической коробки передач требует особой точности и аккуратности. Мы выполняем:</p>
<ul>
<li>Демонтаж старой коробки передач с сохранением всех крепежных элементов</li>
<li>Проверка состояния сцепления (для МКПП) или гидротрансформатора (для АКПП)</li>
<li>Установка новой контрактной коробки передач</li>
<li>Обязательная замена трансмиссионного масла и фильтров</li>
<li>Проверка работы переключения передач и всех режимов</li>
<li>Настройка рычага переключения и тросов</li>
</ul>
<p><strong>Важно:</strong> При замене АКПП мы всегда заменяем масло и фильтры, так как это необходимо для сохранения гарантии и долгой работы коробки передач.</p>
<p>Время выполнения работ по замене КПП составляет от <strong>1 до 2 рабочих дней</strong>.</p>
</div>

<div class="guarantee-section">
<h3>Техническое обслуживание</h3>
<p>После установки контрактного двигателя или КПП мы рекомендуем регулярное техническое обслуживание для обеспечения долгой и надежной работы агрегата:</p>
<ul>
<li>Замена моторного масла и масляного фильтра каждые 10 000 км</li>
<li>Замена воздушного и топливного фильтров</li>
<li>Проверка и замена ремня ГРМ и натяжителей</li>
<li>Диагностика систем охлаждения и смазки</li>
<li>Проверка системы зажигания и топливной системы</li>
<li>Регулировка клапанов и настройка зажигания</li>
</ul>
<p>Регулярное обслуживание поможет избежать преждевременного износа и продлить срок службы контрактного двигателя или КПП.</p>
</div>

<div class="guarantee-section">
<h3>Диагностика и ремонт</h3>
<p>Наш сервис также предоставляет услуги по диагностике и ремонту двигателей и коробок передач:</p>
<ul>
<li>Компьютерная диагностика двигателя и КПП</li>
<li>Диагностика систем автомобиля перед покупкой контрактного агрегата</li>
<li>Ремонт и восстановление двигателей и КПП</li>
<li>Замена изношенных деталей и комплектующих</li>
<li>Регулировка и настройка систем управления</li>
</ul>
<p>Современное диагностическое оборудование позволяет точно определить причину неисправности и предложить оптимальное решение.</p>
</div>

<div class="guarantee-section">
<h3>Почему выбирают наш сервис</h3>
<p>Мы работаем на рынке уже много лет и заслужили репутацию надежного партнера:</p>
<ul>
<li><strong>Опытные мастера</strong> — наши специалисты имеют многолетний опыт работы с автомобилями всех марок</li>
<li><strong>Современное оборудование</strong> — используем профессиональное оборудование для диагностики и ремонта</li>
<li><strong>Гарантия на работы</strong> — предоставляем гарантию на все виды выполненных работ</li>
<li><strong>Качественные запчасти</strong> — используем только проверенные контрактные агрегаты</li>
<li><strong>Быстрое выполнение</strong> — выполняем работы в кратчайшие сроки без потери качества</li>
<li><strong>Прозрачные цены</strong> — честное ценообразование без скрытых доплат</li>
</ul>
</div>

<div class="guarantee-section">
<h3>Как записаться на обслуживание</h3>
<p>Для записи на обслуживание вы можете:</p>
<ul>
<li>Позвонить нам по телефону — наши менеджеры ответят на все вопросы и помогут выбрать удобное время</li>
<li>Приехать к нам в сервис — мы находимся в Алматы по адресам: РВ-90, 7-линия, 29 и ул. Свердлова, 38</li>
<li>Оставить заявку на сайте — мы свяжемся с вами в ближайшее время</li>
</ul>
<p>Перед визитом рекомендуем уточнить наличие необходимого агрегата на складе, чтобы сэкономить ваше время.</p>
</div>', 'Автосервис - Замена Двигателей и КПП в Алматы | Моторленд', 'Профессиональная замена и обслуживание контрактных двигателей и КПП в Алматы. Опытные мастера, современное оборудование, гарантия на работы.', 'замена двигателя алматы, автосервис замена КПП, установка контрактного двигателя, замена АКПП Алматы, сервис контрактных двигателей'],
		['pay_page', 'Оплата и Доставка', 'Доставка и Оплата Контрактных Двигателей', '<div class="guarantee-hero">
<h2>Удобная доставка и оплата контрактных двигателей и КПП</h2>
<p>Компания Motor Land предлагает различные способы оплаты и доставки для вашего удобства. Мы доставляем контрактные двигатели и коробки передач по всему Казахстану и в страны СНГ, обеспечивая безопасную транспортировку и сохранность груза.</p>
</div>

<div class="guarantee-section">
<h3>Способы оплаты</h3>
<p>Мы предлагаем несколько удобных способов оплаты:</p>
<ul>
<li><strong>Наличный расчет</strong> — оплата наличными при получении товара в пункте выдачи или при доставке курьером. Самый простой и быстрый способ оплаты.</li>
<li><strong>Банковский перевод</strong> — перевод на расчетный счет компании. Реквизиты предоставляются после оформления заказа. Подходит для юридических лиц и крупных заказов.</li>
<li><strong>Онлайн оплата картой</strong> — безопасная оплата банковской картой через платежные системы. Оплата проходит в защищенном режиме, ваши данные полностью защищены.</li>
<li><strong>Kaspi.kz / Kaspi Gold</strong> — оплата через Kaspi.kz или рассрочка через Kaspi Gold. Удобный способ оплаты с возможностью рассрочки до 24 месяцев.</li>
</ul>
<p>После оплаты мы сразу начинаем подготовку заказа к отправке. Подтверждение оплаты приходит на ваш email или телефон.</p>
</div>

<div class="guarantee-section">
<h3>Доставка по Казахстану</h3>
<p>Доставка контрактных двигателей и КПП по территории Казахстана осуществляется через транспортные компании:</p>
<ul>
<li><strong>Доставка до терминала ТК</strong> — товар доставляется до терминала транспортной компании в вашем городе. Вы забираете товар самостоятельно. Экономичный вариант доставки.</li>
<li><strong>Доставка до двери</strong> — товар доставляется непосредственно по указанному адресу. Удобно, если нет возможности забрать товар самостоятельно.</li>
<li><strong>Отслеживание груза</strong> — вы можете отслеживать местоположение вашего заказа в режиме реального времени по трек-номеру.</li>
</ul>
<p>Сроки доставки по Казахстану: <strong>3-7 рабочих дней</strong> в зависимости от региона. Доставка в Алматы: <strong>1-2 рабочих дня</strong>.</p>
<p>Стоимость доставки рассчитывается индивидуально в зависимости от веса, габаритов и региона доставки. Точную стоимость уточняйте у менеджера при оформлении заказа.</p>
</div>

<div class="guarantee-section">
<h3>Доставка в страны СНГ</h3>
<p>Мы также осуществляем доставку контрактных двигателей и КПП в страны СНГ:</p>
<ul>
<li>Россия</li>
<li>Беларусь</li>
<li>Узбекистан</li>
<li>Кыргызстан</li>
<li>Таджикистан</li>
<li>Другие страны СНГ</li>
</ul>
<p>Сроки доставки в страны СНГ: <strong>7-14 рабочих дней</strong> в зависимости от страны и региона доставки.</p>
<p>При доставке в страны СНГ требуется предоставление документов для таможенного оформления. Наши менеджеры помогут вам с подготовкой необходимых документов.</p>
</div>

<div class="guarantee-section">
<h3>Самовывоз из офисов в Алматы</h3>
<p>Вы можете забрать товар самостоятельно из наших офисов в Алматы:</p>
<ul>
<li><strong>Офис №1:</strong> РВ-90, 7-линия, 29. <a href="https://2gis.kz/almaty/geo/70000001083496996" target="_blank" style="color: #fe0000; text-decoration: underline;">Посмотреть на карте</a></li>
<li><strong>Офис №2:</strong> ул. Свердлова, 38. <a href="https://2gis.kz/almaty/geo/70000001024156353" target="_blank" style="color: #fe0000; text-decoration: underline;">Посмотреть на карте</a></li>
</ul>
<p>Перед визитом рекомендуем предварительно связаться с нами, чтобы убедиться, что товар готов к выдаче. Это сэкономит ваше время.</p>
<p>Режим работы: <strong>Пн-Сб: 9:00 - 18:00</strong>, <strong>Вс: выходной</strong></p>
</div>

<div class="guarantee-section">
<h3>Курьерская доставка по Алматы</h3>
<p>Для клиентов в Алматы мы предоставляем услугу курьерской доставки:</p>
<ul>
<li><strong>Доставка в день заказа</strong> — если заказ оформлен до 14:00, мы можем доставить товар в тот же день (при наличии товара на складе)</li>
<li><strong>Доставка на следующий день</strong> — стандартная доставка на следующий рабочий день</li>
<li><strong>Стоимость доставки</strong> — от 2000 тенге в зависимости от района и веса товара</li>
</ul>
<p>Курьер свяжется с вами заранее, чтобы уточнить удобное время доставки. При получении товара вы можете проверить его целостность и соответствие заказу.</p>
</div>

<div class="guarantee-section">
<h3>Упаковка и страхование</h3>
<p>Все товары тщательно упаковываются для безопасной транспортировки:</p>
<ul>
<li>Двигатели и КПП упаковываются в защитные пленки и картонные коробки</li>
<li>Используются специальные крепления для предотвращения смещения при транспортировке</li>
<li>Все крепежные элементы и мелкие детали упаковываются отдельно</li>
</ul>
<p><strong>Рекомендуем застраховать груз</strong> при отправке через транспортные компании. Страхование защитит вас от возможных повреждений в пути и позволит получить компенсацию в случае страхового случая.</p>
<p>Стоимость страхования обычно составляет 0.5-1% от стоимости товара и добавляется к стоимости доставки.</p>
</div>

<div class="guarantee-section">
<h3>Условия оплаты и получения</h3>
<p>При получении товара необходимо:</p>
<ul>
<li>Проверить целостность упаковки</li>
<li>Убедиться, что товар соответствует вашему заказу</li>
<li>Проверить наличие всех комплектующих</li>
<li>Оплатить товар (если не была произведена предоплата)</li>
</ul>
<p>В случае обнаружения повреждений или несоответствия заказу, вы имеете право отказаться от товара. Мы обязуемся заменить товар или вернуть оплату в кратчайшие сроки.</p>
<p>Все товары поставляются с документами, подтверждающими покупку, которые необходимы для гарантийного обслуживания.</p>
		</div>', 'Доставка и Оплата | Контрактные Двигатели и КПП | Моторленд', 'Доставка контрактных двигателей и КПП по Казахстану и СНГ. Удобные способы оплаты: наличные, карта, Kaspi. Доставка до двери или самовывоз.', 'доставка двигателей алматы, оплата контрактных моторов, доставка КПП по казахстану, транспортные компании, курьерская доставка']
	];
	*/
	
	if (!empty($default_pages)) {
		$stmt = $_DB_CONECT->prepare("INSERT INTO page_content (page_key, page_name, h1_text, content, meta_title, meta_description, meta_keywords) VALUES (?, ?, ?, ?, ?, ?, ?)");
		foreach ($default_pages as $page) {
			$stmt->bind_param("sssssss", $page[0], $page[1], $page[2], $page[3], $page[4], $page[5], $page[6]);
			$stmt->execute();
		}
		$stmt->close();
	}
}

// Функция для получения контента страницы
function get_page_content($page_key) {
	global $_DB_CONECT;
	
	if (!isset($_DB_CONECT) || !$_DB_CONECT) {
		return false;
	}
	
	$stmt = $_DB_CONECT->prepare("SELECT * FROM page_content WHERE page_key = ? LIMIT 1");
	$stmt->bind_param("s", $page_key);
	$stmt->execute();
	$result = $stmt->get_result();
	
	if ($result->num_rows > 0) {
		$content = $result->fetch_assoc();
		$stmt->close();
		return $content;
	}
	
	$stmt->close();
	return false;
}

// Получение списка всех страниц
if (isset($_REQUEST['page_content_get_all'])) {
	$stmt = $_DB_CONECT->query("SELECT * FROM page_content ORDER BY id ASC");
	$pages = [];
	while ($row = $stmt->fetch_assoc()) {
		$pages[] = $row;
	}
	echo json_encode($pages);
	exit;
}

// Получение одной страницы
if (isset($_REQUEST['page_content_get'])) {
	$page_key = trim($_REQUEST['page_key']);
	$content = get_page_content($page_key);
	if ($content) {
		echo json_encode($content);
	} else {
		echo json_encode(['error' => 'Page not found']);
	}
	exit;
}

// Сохранение контента страницы
if (isset($_REQUEST['page_content_save']) || isset($_REQUEST['comand']) && $_REQUEST['comand'] == 'page_content_save') {
	$page_key = isset($_REQUEST['page_key']) ? trim($_REQUEST['page_key']) : '';
	$page_name = isset($_REQUEST['page_name']) ? trim($_REQUEST['page_name']) : '';
	$h1_text = isset($_REQUEST['h1_text']) ? trim($_REQUEST['h1_text']) : '';
	$content = isset($_REQUEST['content']) ? $_REQUEST['content'] : '';
	$meta_title = isset($_REQUEST['meta_title']) ? trim($_REQUEST['meta_title']) : '';
	$meta_description = isset($_REQUEST['meta_description']) ? trim($_REQUEST['meta_description']) : '';
	$meta_keywords = isset($_REQUEST['meta_keywords']) ? trim($_REQUEST['meta_keywords']) : '';
	
	// Разрешенные страницы для редактирования (модуль отключен - страницы редактируются через customtexts)
	$allowed_pages = [];
	
	if (empty($page_key)) {
		echo json_encode(['success' => false, 'error' => 'Page key is required']);
		exit;
	}
	
	// Проверка, что страница в списке разрешенных
	if (!in_array($page_key, $allowed_pages)) {
		echo json_encode(['success' => false, 'error' => 'Редактирование этой страницы запрещено']);
		exit;
	}
	
	// Проверяем, существует ли страница
	$existing = get_page_content($page_key);
	
	if ($existing) {
		// Обновляем существующую страницу
		$stmt = $_DB_CONECT->prepare("UPDATE page_content SET page_name = ?, h1_text = ?, content = ?, meta_title = ?, meta_description = ?, meta_keywords = ? WHERE page_key = ?");
		$stmt->bind_param("sssssss", $page_name, $h1_text, $content, $meta_title, $meta_description, $meta_keywords, $page_key);
		$stmt->execute();
		$stmt->close();
	} else {
		// Создаем новую страницу
		$stmt = $_DB_CONECT->prepare("INSERT INTO page_content (page_key, page_name, h1_text, content, meta_title, meta_description, meta_keywords) VALUES (?, ?, ?, ?, ?, ?, ?)");
		$stmt->bind_param("sssssss", $page_key, $page_name, $h1_text, $content, $meta_title, $meta_description, $meta_keywords);
		$stmt->execute();
		$stmt->close();
	}
	
	echo json_encode(['success' => true, 'message' => 'Контент страницы успешно сохранен']);
	exit;
}

?>

